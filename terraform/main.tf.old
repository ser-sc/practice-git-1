
terraform {
# Версия terraform
required_version = "0.14.4"
}
provider "google" {
# Версия провайдера
version = "3.51.0"
# ID проекта
project = "infra-300806"
region = "europe-west-1"
}

resource "google_compute_instance" "app" {
#metadata {
# путь до публичного ключа
#ssh-keys = "root:${file("~/root/.ssh/id_rsa.pub")}"
#}

name = "reddit-app"
machine_type = "g1-small"
zone = "europe-west1-b"
tags = ["reddit-app"]
# определение загрузочного диска
boot_disk {
initialize_params {
image = "reddit-base-1609941986"
}
}
connection {
type = "ssh"
user = "root"
agent = false
# путь до приватного ключа
private_key = "${file("~/.ssh/id_rsa.pub")}"
}
}
provisioner "file" {
source = "files/puma.service"
destination = "/tmp/puma.service"
}
provisioner "remote-exec" {
script = "files/deploy.sh"
}
# определение сетевого интерфейса
network_interface {
# сеть, к которой присоединить данный интерфейс
network = "default"
# использовать ephemeral IP для доступа из Интернет
access_config {}
}
}
resource "google_compute_firewall" "firewall_puma" {
name = "allow-puma-default"
# Название сети, в которой действует правило
network = "default"
# Какой доступ разрешить
allow {
protocol = "tcp"
ports = ["9292"]
}
# Каким адресам разрешаем доступ
source_ranges = ["0.0.0.0/0"]
# Правило применимо для инстансов с перечисленными тэгами
target_tags = ["reddit-app"]
}
